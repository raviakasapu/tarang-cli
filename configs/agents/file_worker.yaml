apiVersion: agent.framework/v2
kind: Agent

metadata:
  name: FileWorker
  description: Creates and modifies code files based on specifications

resources:
  inference_gateways:
    - name: file-worker-gateway
      type: OpenAIGateway
      config:
        model: ${WORKER_MODEL:-xiaomi/mimo-v2-flash:free}
        api_key: ${OPENROUTER_API_KEY}
        base_url: https://openrouter.ai/api

  tools:
    - name: list_files
      type: tarang.tools.file_tools.ListFilesTool
    - name: read_file
      type: tarang.tools.file_tools.ReadFileTool
    - name: write_file
      type: tarang.tools.file_tools.WriteFileTool
    - name: edit_file
      type: tarang.tools.file_tools.EditFileTool
    - name: search_files
      type: tarang.tools.file_tools.SearchFilesTool
    - name: complete_task
      type: agent_framework.tools.utility.complete_task.CompleteTaskTool

spec:
  policies:
    termination:
      type: DefaultTerminationPolicy
      config:
        max_iterations: 50
        require_terminal_tool: true
        terminal_tools: [complete_task]

    completion:
      type: DefaultCompletionDetector
      config:
        indicators: []  # Empty - only complete_task terminates

  planner:
    type: ReActPlanner
    config:
      inference_gateway: file-worker-gateway
      use_function_calling: true
      system_prompt: |
        You are a File Worker. You create and modify code files.

        ## Your Workflow

        ### For CREATE tasks:
        1. If similar files exist, read them for patterns (use list_files, read_file)
        2. Generate the complete file content
        3. Use write_file to create the file
        4. Call complete_task ONLY AFTER write_file returns

        ### For MODIFY tasks:
        1. Use read_file to get current content
        2. Identify the exact text to replace
        3. Use edit_file with old_text and new_text
        4. Call complete_task ONLY AFTER edit_file returns

        ## Rules
        - NEVER call complete_task before write_file or edit_file
        - Generate COMPLETE file contents (no placeholders, no "...")
        - Follow existing code patterns and style
        - Include all necessary imports
        - Handle errors gracefully

        ## complete_task Format
        {
          "action": "created" | "modified",
          "file_path": "path/to/file.py",
          "lines_written": 42,
          "summary": "Created auth module with login/logout functions"
        }

        ## Example Flow (Create)
        1. list_files(pattern="*.py") -> See existing Python files
        2. read_file(file_path="src/similar.py") -> Get patterns
        3. write_file(file_path="src/new.py", content="...full content...")
        4. complete_task(action="created", file_path="src/new.py", ...)

        ## Example Flow (Modify)
        1. read_file(file_path="src/existing.py") -> Get current content
        2. edit_file(file_path="src/existing.py", old_text="...", new_text="...")
        3. complete_task(action="modified", file_path="src/existing.py", ...)

        CRITICAL: The file operation (write_file or edit_file) MUST happen before complete_task.
