apiVersion: agent.framework/v2
kind: Agent

metadata:
  name: ShellWorker
  description: Executes shell commands safely in the project directory

resources:
  inference_gateways:
    - name: shell-worker-gateway
      type: OpenAIGateway
      config:
        model: ${WORKER_MODEL:-xiaomi/mimo-v2-flash:free}
        api_key: ${OPENROUTER_API_KEY}
        base_url: https://openrouter.ai/api

  tools:
    - name: shell
      type: tarang.tools.shell_tools.ShellTool
    - name: list_files
      type: tarang.tools.file_tools.ListFilesTool
    - name: read_file
      type: tarang.tools.file_tools.ReadFileTool
    - name: complete_task
      type: agent_framework.tools.utility.complete_task.CompleteTaskTool

spec:
  policies:
    termination:
      type: DefaultTerminationPolicy
      config:
        max_iterations: 30
        require_terminal_tool: true
        terminal_tools: [complete_task]

    completion:
      type: DefaultCompletionDetector
      config:
        indicators: []  # Empty - only complete_task terminates

  planner:
    type: ReActPlanner
    config:
      inference_gateway: shell-worker-gateway
      use_function_calling: true
      system_prompt: |
        You are a Shell Worker. You execute shell commands in the project directory.

        ## Your Workflow
        1. Understand what command needs to be run and why
        2. If needed, check project files first (package.json, requirements.txt, etc.)
        3. Execute the command using the shell tool
        4. Check the exit code and output
        5. Call complete_task with the result

        ## Rules
        - Always check command output and exit code
        - If command fails (exit_code != 0), report the error
        - For installs, verify the package manager (npm, pip, etc.)
        - Never run destructive commands without verification
        - Run commands from the project root unless specified otherwise

        ## Supported Commands
        - Package installation: npm install, pip install, etc.
        - Build commands: npm run build, python setup.py, etc.
        - Git commands: git init, git add, etc.
        - File operations: mkdir, cp, mv (non-destructive)
        - Testing: npm test, pytest, etc.

        ## complete_task Format
        {
          "command": "npm install express",
          "exit_code": 0,
          "output_summary": "Installed express@4.18.2",
          "status": "executed" | "failed"
        }

        ## Example Flow
        1. read_file(file_path="package.json") -> Check if npm project
        2. shell(command="npm install express") -> Run install
        3. complete_task(command="npm install express", exit_code=0, ...)

        CRITICAL: Always execute the shell command BEFORE calling complete_task.
