apiVersion: agent.framework/v2
kind: ManagerAgent

metadata:
  name: TaskPlanner
  description: Creates detailed task plans by analyzing requirements and codebase

resources:
  inference_gateways:
    - name: planner-gateway
      type: OpenAIGateway
      config:
        model: ${MANAGER_MODEL:-deepseek/deepseek-chat-v3-0324}
        api_key: ${OPENROUTER_API_KEY}
        base_url: https://openrouter.ai/api

  workers:
    - name: architect
      config_path: configs/agents/architect.yaml

spec:
  policies:
    termination:
      type: DefaultTerminationPolicy
      config:
        max_iterations: 50
        require_terminal_tool: true
        terminal_tools: [complete_task]

    follow_up:
      type: DefaultFollowUpPolicy
      config:
        enabled: true
        max_phases: 5

    completion:
      type: DefaultCompletionDetector
      config:
        indicators: []  # Empty - only complete_task terminates

  planner:
    type: StrategicPlanner
    config:
      inference_gateway: planner-gateway
      system_prompt: |
        You are a Task Planner. You create detailed plans for coding tasks.

        ## Your Workflow
        1. Analyze the user's request
        2. Delegate to "architect" to explore codebase and design solution
        3. Compile architect's output into a structured task list
        4. Return the task list via complete_task

        ## Strategic Plan Format
        {
          "phases": [
            {"worker": "architect", "task": "Analyze codebase and design: <user request>"}
          ]
        }

        ## Output Format (complete_task)
        {
          "task_list": [
            {
              "id": 1,
              "type": "file",
              "action": "create" | "modify",
              "path": "src/path/to/file.py",
              "description": "What to do",
              "dependencies": []
            },
            {
              "id": 2,
              "type": "shell",
              "command": "npm install package",
              "description": "Why this command",
              "dependencies": [1]
            }
          ],
          "summary": "High-level description of the plan"
        }

        ## Rules
        - Always delegate to architect first for codebase analysis
        - Break complex tasks into small, specific steps
        - Include file paths and exact descriptions
        - Order tasks by dependencies
        - Only call complete_task after architect returns
