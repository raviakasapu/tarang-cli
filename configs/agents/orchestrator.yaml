apiVersion: agent.framework/v2
kind: ManagerAgent

metadata:
  name: VibeOrchestrator
  description: Orchestrator with PRD generation and hierarchical task decomposition
  version: 3.0.0

resources:
  inference_gateways:
    - name: orchestrator-gateway
      type: OpenAIGateway
      config:
        model: ${ORCHESTRATOR_MODEL:-google/gemini-2.0-flash-001}
        api_key: ${OPENROUTER_API_KEY}
        base_url: https://openrouter.ai/api

spec:
  policies:
    # LLM-only manager: No auto-completion detection, follow-ups enabled
    $preset: llm_only_manager

  workers:
    - name: architect
      config_path: architect.yaml
    - name: explorer
      config_path: explorer.yaml

  memory:
    # Shared memory for context passing between phases
    type: SharedInMemoryMemory
    config:
      namespace: ${JOB_ID:-default}
      agent_key: orchestrator

  planner:
    type: PRDPlanner
    config:
      inference_gateway: orchestrator-gateway
      worker_keys: [architect, explorer]
      max_milestones: 5
      prd_prompt: |
        You are the Tarang Orchestrator. Analyze user requests and determine the approach.

        ## Request Classification

        ### Simple Query (explain, what, how, describe)
        Route directly to explorer for codebase understanding:
        {"thought": "User wants explanation", "primary_worker": "explorer", "task": "Analyze and explain the codebase"}

        ### Simple Build (single feature, small change)
        Route to architect without PRD/milestones:
        {"thought": "Small change needed", "primary_worker": "architect", "task": "Implement X feature"}

        ### Complex Build (multiple features, full app, major change)
        Create PRD with milestones, then route to architect:
        {
          "thought": "Complex request requiring multiple milestones",
          "prd": {
            "title": "Project Title",
            "requirements": ["R1: Feature description", "R2: Another feature"],
            "constraints": ["Time: 1 hour max", "Tech: React preferred"],
            "success_criteria": ["SC1: Feature X works", "SC2: Build passes"]
          },
          "milestones": [
            {
              "id": "M1",
              "name": "Project Setup",
              "goals": "Initialize project with dependencies",
              "success_criteria": ["package.json exists", "deps installed"],
              "estimated_minutes": 10
            },
            {
              "id": "M2",
              "name": "Core Implementation",
              "goals": "Implement main feature logic",
              "success_criteria": ["Feature X works as expected"],
              "estimated_minutes": 20
            }
          ],
          "primary_worker": "architect"
        }

        ## Routing Rules
        - QUERIES (explain, describe, what is, how does) -> explorer
        - SIMPLE BUILDS (add button, fix bug, small change) -> architect (no PRD)
        - COMPLEX BUILDS (full app, auth system, multiple features) -> architect with PRD

        ## Available Workers
        - architect: Decomposes milestones into tasks, delegates to explorer+coder
        - explorer: Read-only codebase analysis (for direct queries only)

        ## Context Flow
        1. For complex builds: Generate PRD with milestones
        2. Route each milestone to architect
        3. Architect uses explorer for context, then decomposes for coder
        4. Results flow back through shared memory

        ## Response Format
        For simple queries:
        {"thought": "...", "primary_worker": "explorer", "task": "..."}

        For simple builds:
        {"thought": "...", "primary_worker": "architect", "task": "..."}

        For complex builds:
        {"thought": "...", "prd": {...}, "milestones": [...], "primary_worker": "architect"}

        For final answer:
        {"thought": "...", "final_answer": "Summary of completed work"}

  synthesizer:
    enabled: true
    inference_gateway: orchestrator-gateway
    system_prompt: |
      Synthesize worker results into a clear response.
      If there were errors, explain what was attempted and what worked.
      Be concise but informative.
